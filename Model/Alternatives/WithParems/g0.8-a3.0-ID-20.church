(define (goal-prior) (multinomial goals '(0.8 0.1 0.1)))
(define alpha 3.0)
(define categories (list 'target 'gorilla 'bear 'tiger 'person 'snake 'ox))
(define utterances (list 'target 'gorilla 'bear 'tiger 'person 'snake 'ox))
(define (utterance-prior) (multinomial utterances '(0.1 0.1 0.1 0.1 0.1 0.1 0.1)))
(define (categories-prior) (multinomial categories '(0.00166666666667 0.00166666666667 0.00166666666667 0.00166666666667 0.99 0.00166666666667 0.00166666666667)))
(define featureSet-prior (list(list '0.277279005 '0.11756304 '0.124615389 '0.078134195 '0.134660233 '0.08640885 '0.106373997 '0.07496529)(list '0.288585242 '0.13154668 '0.188308107 '0.077940698 '0.098493012 '0.07669235 '0.083611274 '0.054822639)(list '0.224349635 '0.119562083 '0.123318993 '0.100784993 '0.149178917 '0.099153855 '0.097464962 '0.086186562)(list '0.370755423 '0.149149684 '0.109969001 '0.078613316 '0.101668146 '0.067467863 '0.079488792 '0.042887776)(list '0.113960822 '0.083391612 '0.095578073 '0.092886012 '0.134899654 '0.133801915 '0.170918018 '0.174563894)(list '0.318160423 '0.113599822 '0.145406883 '0.092026903 '0.121586978 '0.065059781 '0.086139019 '0.058020192)(list '0.325420765 '0.101909049 '0.166118221 '0.061502857 '0.124872158 '0.058409548 '0.108571199 '0.053196203)))
;; This model will not run as the feature priors are not defined.
;; We will define the parameters separately and concatenate with this code.

;(define (goal-prior) (multinomial goals '(0.33 0.33 0.33)))

(define featureSets (list '(1 1 1) '(1 1 0) '(1 0 1) '(1 0 0) '(0 1 1) '(0 1 0) '(0 0 1) '(0 0 0)))

;; Parameters
(define depth 1)

;; Define communicative goals as wanting to communicate something about John's category vs his fierceness
(define goals (list 'goal-feature1 'goal-feature2 'goal-feature3))

(define (sample-featureSet category prior all-categories)
(if (equal? category (first all-categories))
(multinomial featureSets (first prior))
(sample-featureSet category (rest prior) (rest all-categories))
)
)

(define (literal-interpretation utterance category)
(equal? utterance category))


(define (goal-satisfied? goal listener-category-feature1-feature2-feature3 speaker-category speaker-feature1 speaker-feature2 speaker-feature3)
(case goal
(('goal-feature1) (equal? (second listener-category-feature1-feature2-feature3) speaker-feature1))
(('goal-feature2) (equal? (third listener-category-feature1-feature2-feature3) speaker-feature2))
(('goal-feature3) (equal? (fourth listener-category-feature1-feature2-feature3) speaker-feature3))
))


;; The model is currently restricted to hardness=1
(define speaker
(mem (lambda (category feature1 feature2 feature3 goal depth)
(enumeration-query
(define utterance (utterance-prior))
utterance
(goal-satisfied? goal (apply multinomial (listener utterance depth)) category feature1 feature2 feature3)
))))

(define listener
(mem (lambda (utterance depth)
(enumeration-query
(define category (categories-prior))
(define featureSet (sample-featureSet category featureSet-prior categories))
(define feature1 (first featureSet))
(define feature2 (second featureSet))
(define feature3 (third featureSet))
(define speaker-goal (goal-prior))

;(list category fierceness skinniness)
(list category feature1 feature2 feature3)

(if (equal? depth 0)
(literal-interpretation utterance category)
(equal? utterance
(apply multinomial (raise-to-power (speaker category feature1 feature2 feature3 speaker-goal (- depth 1)) alpha))))
))))

(define (raise-to-power speaker-dist alpha)
(list (first speaker-dist) (map (lambda (x) (pow x alpha)) (second speaker-dist))))

(define (sample-one utterance)
(listener utterance depth))

(sample-one 'target)
